---
import SectionTitle from "./SectionTitle.astro";

const WEB3FORMS_ACCESS_KEY = import.meta.env.WEB3FORMS_ACCESS_KEY || '';
---
<section id="contact" class="py-24">
  <div class="text-center mb-16">
    <SectionTitle
      title="Contactez-moi"
      subtitle="Opportunité CDI, projet impactant ou collaboration ? Je suis à votre écoute pour discuter de votre prochain défi technique."
    />
    
    <!-- Contact info -->
    <div class="flex flex-wrap justify-center gap-8 mt-8">
      <div class="flex items-center gap-2 text-muted">
        <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
        <span>contact@sylvain-dev.fr</span>
      </div>
      <div class="flex items-center gap-2 text-muted">
        <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Réponse sous 24h</span>
      </div>
    </div>
    
    <!-- Social links -->
    <div class="flex justify-center gap-4 mt-6">
      <a 
        href="https://github.com/SylDav" 
        target="_blank" 
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-4 py-2 bg-card border border-border rounded-lg hover:bg-accent/10 hover:border-accent/50 transition-all text-sm"
        aria-label="Visiter mon profil GitHub"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        GitHub
      </a>
      <a 
        href="https://linkedin.com/in/sylvain-david-663253105" 
        target="_blank" 
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-4 py-2 bg-card border border-border rounded-lg hover:bg-accent/10 hover:border-accent/50 transition-all text-sm"
        aria-label="Visiter mon profil LinkedIn"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
        </svg>
        LinkedIn
      </a>
    </div>
  </div>

  <div class="max-w-2xl mx-auto">
    <form 
      id="contact-form" 
      class="space-y-6"
      method="POST"
      action="https://api.web3forms.com/submit"
    >
      <!-- Web3Forms Access Key -->
      <input type="hidden" name="access_key" value={WEB3FORMS_ACCESS_KEY} />
      
      <!-- Grid for name and email -->
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Name Field -->
        <div class="space-y-2">
          <label for="name" class="block text-sm font-medium text-text-main">
            Nom complet <span class="text-accent">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted"
            placeholder="Jean Dupont"
          />
          <span class="text-xs text-muted hidden" id="name-error">Veuillez entrer votre nom</span>
        </div>

        <!-- Email Field -->
        <div class="space-y-2">
          <label for="email" class="block text-sm font-medium text-text-main">
            Email <span class="text-accent">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted"
            placeholder="jean@exemple.com"
          />
          <span class="text-xs text-muted hidden" id="email-error">Veuillez entrer un email valide</span>
        </div>
      </div>

      <!-- Subject Field -->
      <div class="space-y-2">
        <label for="subject" class="block text-sm font-medium text-text-main">
          Objet <span class="text-accent">*</span>
        </label>
        <input
          type="text"
          id="subject"
          name="subject"
          required
          class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted"
          placeholder="Ex: Opportunité CDI, Projet santé, Collaboration..."
        />
        <span class="text-xs text-muted hidden" id="subject-error">Veuillez entrer un objet</span>
      </div>

      <!-- Message Field -->
      <div class="space-y-2">
        <label for="message" class="block text-sm font-medium text-text-main">
          Message <span class="text-accent">*</span>
        </label>
        <textarea
          id="message"
          name="message"
          rows="5"
          required
          class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted resize-none"
          placeholder="Décrivez votre projet ou votre demande..."
        ></textarea>
        <span class="text-xs text-muted hidden" id="message-error">Veuillez entrer votre message (minimum 10 caractères)</span>
      </div>

      <!-- Privacy and Submit -->
      <div class="space-y-4">
        <!-- Privacy Checkbox -->
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            id="privacy"
            name="privacy"
            required
            class="mt-1 w-4 h-4 text-accent bg-card border-border rounded focus:ring-accent/50"
          />
          <label for="privacy" class="text-sm text-muted">
            J'accepte que mes données soient traitées pour répondre à ma demande. 
            Conformément à la RGPD, vous disposez d'un droit d'accès, de modification et de suppression de vos données.
          </label>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-4">
          <button
            type="submit"
            id="submit-btn"
            class="btn-primary flex-1 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            <span id="submit-text">Envoyer le message</span>
          </button>
          
          <!-- Alternative contact -->
          <a
            href="mailto:sylvain.david.60@gmail.com"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-border rounded-lg hover:bg-card transition-colors text-sm"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            Email direct
          </a>
        </div>
      </div>

      <!-- Success/Error Messages -->
      <div id="form-message" class="hidden p-4 rounded-lg"></div>
    </form>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const formMessage = document.getElementById('form-message') as HTMLDivElement;
  const subject = document.getElementById('subject') as HTMLSelectElement;
  
  if (!form || !submitBtn || !submitText || !formMessage || !subject) return;

  // Form validation
  function validateForm(): boolean {
    let isValid = true;
    const fields = ['name', 'email', 'subject', 'message'];

    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId) as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
      const error = document.getElementById(`${fieldId}-error`) as HTMLSpanElement;
      
      if (!field?.value.trim()) {
        error?.classList.remove('hidden');
        field?.classList.add('border-red-500');
        isValid = false;
      } else if (fieldId === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailField = field as HTMLInputElement;
        if (!emailRegex.test(emailField.value)) {
          error?.classList.remove('hidden');
          field?.classList.add('border-red-500');
          isValid = false;
        } else {
          error?.classList.add('hidden');
          field?.classList.remove('border-red-500');
        }
      } else if (fieldId === 'message') {
        const messageField = field as HTMLTextAreaElement;
        if (messageField.value.trim().length < 10) {
          error?.classList.remove('hidden');
          field?.classList.add('border-red-500');
          isValid = false;
        } else {
          error?.classList.add('hidden');
          field?.classList.remove('border-red-500');
        }
      } else {
        error?.classList.add('hidden');
        field?.classList.remove('border-red-500');
      }
    });

    // Privacy checkbox
    const privacyCheckbox = document.getElementById('privacy') as HTMLInputElement;
    if (!privacyCheckbox?.checked) {
      isValid = false;
    }

    return isValid;
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!validateForm()) {
      showMessage('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitText.textContent = 'Envoi en cours...';

    const formData = new FormData(form);

    try {
      // Send to Web3Forms
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok && result.success) {
        showMessage('Message envoyé avec succès ! Je vous répondrai dans les plus brefs délais.', 'success');
        form.reset();
      } else {
        throw new Error(result.message || 'Erreur lors de l\'envoi');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      console.error('Data sent:', Object.fromEntries(formData.entries()));
      showMessage('Erreur lors de l\'envoi. Veuillez réessayer ou utiliser l\'email direct.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitText.textContent = 'Envoyer le message';
    }
  });

  function showMessage(text: string, type: 'success' | 'error' | 'info'): void {
    formMessage.textContent = text;
    formMessage.classList.remove('hidden');
    
    // Style based on type
    formMessage.className = 'p-4 rounded-lg';
    if (type === 'success') {
      formMessage.classList.add('bg-green-500/20', 'text-green-400', 'border', 'border-green-500/30');
    } else if (type === 'error') {
      formMessage.classList.add('bg-red-500/20', 'text-red-400', 'border', 'border-red-500/30');
    } else {
      formMessage.classList.add('bg-blue-500/20', 'text-blue-400', 'border', 'border-blue-500/30');
    }

    // Auto-hide after 5 seconds
    setTimeout(() => {
      formMessage.classList.add('hidden');
    }, 5000);
  }

  // Real-time validation
  const fields = ['name', 'email', 'subject', 'message'];
  fields.forEach(fieldId => {
    const field = document.getElementById(fieldId) as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
    field?.addEventListener('blur', () => {
      const error = document.getElementById(`${fieldId}-error`) as HTMLSpanElement;
      if (field?.value.trim()) {
        error?.classList.add('hidden');
        field?.classList.remove('border-red-500');
      }
    });
  });
});
</script>