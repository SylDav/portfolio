---
import SectionTitle from "./SectionTitle.astro";
---

<section id="contact" class="py-24">
  <div class="text-center mb-16">
    <SectionTitle
      title="Contactez-moi"
      subtitle="Envie de collaborer sur un projet ou simplement échanger ? Je suis à votre écoute."
    />
    
    <!-- Contact info -->
    <div class="flex flex-wrap justify-center gap-8 mt-8">
      <div class="flex items-center gap-2 text-muted">
        <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
        <span>contact@sylvain-dev.fr</span>
      </div>
      <div class="flex items-center gap-2 text-muted">
        <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Réponse sous 24h</span>
      </div>
    </div>
  </div>

  <div class="max-w-2xl mx-auto">
    <form 
      id="contact-form" 
      class="space-y-6"
      method="POST"
      action="/api/contact"
      data-netlify="true"
    >
      <!-- Grid for name and email -->
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Name Field -->
        <div class="space-y-2">
          <label for="name" class="block text-sm font-medium text-text-main">
            Nom complet <span class="text-accent">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted"
            placeholder="Jean Dupont"
          />
          <span class="text-xs text-muted hidden" id="name-error">Veuillez entrer votre nom</span>
        </div>

        <!-- Email Field -->
        <div class="space-y-2">
          <label for="email" class="block text-sm font-medium text-text-main">
            Email <span class="text-accent">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted"
            placeholder="jean@exemple.com"
          />
          <span class="text-xs text-muted hidden" id="email-error">Veuillez entrer un email valide</span>
        </div>
      </div>

      <!-- Subject Field -->
      <div class="space-y-2">
        <label for="subject" class="block text-sm font-medium text-text-main">
          Objet <span class="text-accent">*</span>
        </label>
        <select
          id="subject"
          name="subject"
          required
          class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main"
        >
          <option value="">Sélectionnez un objet</option>
          <option value="projet">Projet freelance</option>
          <option value="emploi">Opportunité d'emploi</option>
          <option value="collaboration">Collaboration</option>
          <option value="autre">Autre</option>
        </select>
        <span class="text-xs text-muted hidden" id="subject-error">Veuillez sélectionner un objet</span>
      </div>

      <!-- Message Field -->
      <div class="space-y-2">
        <label for="message" class="block text-sm font-medium text-text-main">
          Message <span class="text-accent">*</span>
        </label>
        <textarea
          id="message"
          name="message"
          rows="5"
          required
          class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main placeholder-text-muted resize-none"
          placeholder="Décrivez votre projet ou votre demande..."
        ></textarea>
        <span class="text-xs text-muted hidden" id="message-error">Veuillez entrer votre message (minimum 10 caractères)</span>
      </div>

      <!-- Project Type (conditional) -->
      <div id="project-type-field" class="space-y-2 hidden">
        <label for="project-type" class="block text-sm font-medium text-text-main">
          Type de projet
        </label>
        <select
          id="project-type"
          name="project-type"
          class="w-full px-4 py-3 bg-card border border-border rounded-lg focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all text-text-main"
        >
          <option value="">Sélectionnez un type</option>
          <option value="site-web">Site web</option>
          <option value="application">Application web</option>
          <option value="api">API REST</option>
          <option value="maintenance">Maintenance/Mise à jour</option>
          <option value="conseil">Conseil technique</option>
        </select>
      </div>

      <!-- Privacy and Submit -->
      <div class="space-y-4">
        <!-- Privacy Checkbox -->
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            id="privacy"
            name="privacy"
            required
            class="mt-1 w-4 h-4 text-accent bg-card border-border rounded focus:ring-accent/50"
          />
          <label for="privacy" class="text-sm text-muted">
            J'accepte que mes données soient traitées pour répondre à ma demande. 
            Conformément à la RGPD, vous disposez d'un droit d'accès, de modification et de suppression de vos données.
          </label>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-4">
          <button
            type="submit"
            id="submit-btn"
            class="btn-primary flex-1 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            <span id="submit-text">Envoyer le message</span>
          </button>
          
          <!-- Alternative contact -->
          <a
            href="mailto:contact@sylvain-dev.fr"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-border rounded-lg hover:bg-card transition-colors text-sm"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            Email direct
          </a>
        </div>
      </div>

      <!-- Success/Error Messages -->
      <div id="form-message" class="hidden p-4 rounded-lg"></div>
    </form>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const formMessage = document.getElementById('form-message') as HTMLDivElement;
  const subjectSelect = document.getElementById('subject') as HTMLSelectElement;
  const projectTypeField = document.getElementById('project-type-field') as HTMLDivElement;
  
  if (!form || !submitBtn || !submitText || !formMessage || !subjectSelect || !projectTypeField) return;

  // Show/hide project type based on subject
  subjectSelect.addEventListener('change', (e) => {
    const target = e.target as HTMLSelectElement;
    if (target.value === 'projet') {
      projectTypeField.classList.remove('hidden');
    } else {
      projectTypeField.classList.add('hidden');
    }
  });

  // Form validation
  function validateForm(): boolean {
    let isValid = true;
    const fields = ['name', 'email', 'subject', 'message'];

    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId) as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
      const error = document.getElementById(`${fieldId}-error`) as HTMLSpanElement;
      
      if (!field?.value.trim()) {
        error?.classList.remove('hidden');
        field?.classList.add('border-red-500');
        isValid = false;
      } else if (fieldId === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailField = field as HTMLInputElement;
        if (!emailRegex.test(emailField.value)) {
          error?.classList.remove('hidden');
          field?.classList.add('border-red-500');
          isValid = false;
        } else {
          error?.classList.add('hidden');
          field?.classList.remove('border-red-500');
        }
      } else if (fieldId === 'message') {
        const messageField = field as HTMLTextAreaElement;
        if (messageField.value.trim().length < 10) {
          error?.classList.remove('hidden');
          field?.classList.add('border-red-500');
          isValid = false;
        } else {
          error?.classList.add('hidden');
          field?.classList.remove('border-red-500');
        }
      } else {
        error?.classList.add('hidden');
        field?.classList.remove('border-red-500');
      }
    });

    // Privacy checkbox
    const privacyCheckbox = document.getElementById('privacy') as HTMLInputElement;
    if (!privacyCheckbox?.checked) {
      isValid = false;
    }

    return isValid;
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!validateForm()) {
      showMessage('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitText.textContent = 'Envoi en cours...';

    const formData = new FormData(form);
    const data: Record<string, string> = {};
    
    formData.forEach((value, key) => {
      if (typeof value === 'string') {
        data[key] = value;
      }
    });

    try {
      // Send to Netlify (or your preferred service)
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        showMessage('Message envoyé avec succès ! Je vous répondrai dans les plus brefs délais.', 'success');
        form.reset();
        projectTypeField.classList.add('hidden');
      } else {
        throw new Error('Erreur lors de l\'envoi');
      }
    } catch (error) {
      // Fallback to direct email
      const mailtoLink = `mailto:contact@sylvain-dev.fr?subject=${encodeURIComponent(data.subject)}&body=${encodeURIComponent(`Nom: ${data.name}\nEmail: ${data.email}\n\n${data.message}`)}`;
      window.location.href = mailtoLink;
      showMessage('Ouverture de votre client email...', 'info');
    } finally {
      submitBtn.disabled = false;
      submitText.textContent = 'Envoyer le message';
    }
  });

  function showMessage(text: string, type: 'success' | 'error' | 'info'): void {
    formMessage.textContent = text;
    formMessage.classList.remove('hidden');
    
    // Style based on type
    formMessage.className = 'p-4 rounded-lg';
    if (type === 'success') {
      formMessage.classList.add('bg-green-500/20', 'text-green-400', 'border', 'border-green-500/30');
    } else if (type === 'error') {
      formMessage.classList.add('bg-red-500/20', 'text-red-400', 'border', 'border-red-500/30');
    } else {
      formMessage.classList.add('bg-blue-500/20', 'text-blue-400', 'border', 'border-blue-500/30');
    }

    // Auto-hide after 5 seconds
    setTimeout(() => {
      formMessage.classList.add('hidden');
    }, 5000);
  }

  // Real-time validation
  const fields = ['name', 'email', 'subject', 'message'];
  fields.forEach(fieldId => {
    const field = document.getElementById(fieldId) as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
    field?.addEventListener('blur', () => {
      const error = document.getElementById(`${fieldId}-error`) as HTMLSpanElement;
      if (field?.value.trim()) {
        error?.classList.add('hidden');
        field?.classList.remove('border-red-500');
      }
    });
  });
});
</script>